---
title: "Phthalate & phenol exposure patterns"
subtitle: "& child intelligence in M&N cohort"
author: "Lizzy Gibson"
date: "3/16/2021"
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align='center', echo=FALSE)
options(scipen = 999)
library(haven)
library(tidyverse)
library(RColorBrewer)
library(mgcv)
library(EnvStats)
library(janitor)
library(gt)
library(reshape2)
library(broom)
library(tableone)
library(xtable)
library(GGally)
library(gtsummary)
library(huxtable)
library(rcompanion)
library(R.matlab)
library(MNdata) # Local package
library(ggsci)
library(patchwork)
library(rstan)
library(bayesplot)
library(shinystan)
library(rstanarm)
library(tictoc)
library(recipes)

theme_set(theme_bw(base_size = 20) + 
            theme(strip.background = element_rect(fill="white"),
                  axis.text.x = element_text(angle = 45, hjust = 1),
                  legend.title = element_text(size = 12),
                  legend.position = "bottom", 
                  legend.text = element_text(size = 7)))

options(
  ggplot2.discrete.color = pal_nejm()(8),
  ggplot2.discrete.fill = pal_nejm()(8))
```

```{r, functions}
# Get lower triangle of the correlation matrix
get_lower_tri<-function(x){
  x[upper.tri(x)] <- NA
  
  for (i in 1:nrow(x)) {
    for (j in 1:ncol(x)) {
      if (j == i) {x[i,j] <- NA}
    }
  }
  
  return(x)
}

tidy_ci = function(fit) {
              tidy(fit) %>% bind_cols(., as_tibble(confint(fit)))
}

add_ci4interaction <- function(fit, term1, term2) {
    # CONFIDENCE INTERVAL for pattern in females
    # Compute association and its uncertainty 
    
    # here we create tables of coefficients and covariance
    coef.mat <- summary(fit)$coefficients
    var.mat  <- vcov(fit)
    
    # the total term for the association is the 
    # sum of P2 in the reference sex plus the term for P2:female
    beta.Pf <- coef.mat[term1,1] + coef.mat[term2,1]
    
    # Compute variance in order to compute standard error
    # We must compute the variance for the total term 
    # Var(Beta1 + Beta2) = Var(Beta1) + Var(Beta2) + 2*CoVar(Beta1, Beta2) 
    var.Pf <- var.mat[term1, term1] + 
              var.mat[term2, term2] +
              2*var.mat[term1, term2]
    
    # this is st error NOT std
    ste.Pf  <-  sqrt(abs(var.Pf))

    # compute confidence intervals 
    lci.Pf <- beta.Pf - 1.96*ste.Pf
    uci.Pf <- beta.Pf + 1.96*ste.Pf
    
    # 2 calculate the test statistic: t = Est/SE
    # 3 calculate the P value2: P = exp(−0.717×z − 0.416×z2).
    test_stat = abs(beta.Pf/ste.Pf)
    pvalue = exp(-0.717*test_stat - 0.416*test_stat^2)
    pvalue
    
    tidy_ci(fit) %>% 
      bind_rows(., tibble(term = paste0(term1, " in females"), estimate = beta.Pf, std.error = ste.Pf,
                statistic = test_stat, p.value = pvalue, `2.5 %` = lci.Pf, `97.5 %` = uci.Pf)) %>% 
      mutate(term = ifelse(term == term1, paste(term1, "in males"), term))
}

add_ci4int_bayes = function(fit) {
int_sum = summary(fit, c("beta_int", "beta_sex", "beta_p"))$summary

params = names(p1_non)[grep("(alpha|beta)", names(p1_non))]
model_sum = summary(fit, params)$summary

ext <- extract(fit)

post_coef = cbind(ext$alpha, ext$beta_c, 
                     ext$beta_int, ext$beta_sex, ext$beta_p) %>% as_tibble()

colnames(post_coef) = params
int_coefs = post_coef %>% dplyr::select(beta_p, beta_int)

coef1 = int_coefs$beta_p
coef2 = int_coefs$beta_int

covmat = cov(int_coefs)
beta_f = coef1 + coef2

var_f = covmat[1, 1] + 
              covmat[2, 2] +
              2*covmat[1, 2]

# this is std dev not std error
sd_f  <- sqrt(abs(var_f))

# take min sample size as conservative est.
sampsize = min(int_sum[1,9], int_sum[3,9])

# this is std error
se_f  <- sd_f/sqrt(sampsize)

lci.f <- mean(beta_f) - 1.96*se_f
uci.f <- mean(beta_f) + 1.96*se_f

# 2 calculate the test statistic: t = Est/SE
# 3 calculate the P value2: P = exp(−0.717×z − 0.416×z2).
# test_stat = abs(mean(beta_f)/se_f)
# pvalue = exp(-0.717*test_stat - 0.416*test_stat^2)
# NO BAYESIAN PVALUE

q = quantile(beta_f, probs = c(0.025, .25, .50, .75, .975)) %>% as.data.frame() %>% 
  rownames_to_column() %>% 
  pivot_wider(names_from = "rowname",
              values_from = ".")

new_var = tibble(beta = "p in females", mean = round(mean(beta_f), 4), 
                 se_mean = round(se_f,4), sd = round(sd_f,4)) %>% 
          bind_cols(., q)

# M_AGE + M_EDU + MARITAL_STATUS + HOME_SCORE + M_IQ + ALCOHOL + mat_hard, 
as.data.frame(model_sum)[,-c(9:10)] %>% 
  rownames_to_column(var="beta") %>% 
  mutate(beta = c("alpha", "age", "edu", "marital", "home", "iq", "alcohol", "mat_hard",
                  "sex*p", "sex", "p in males")) %>% 
  bind_rows(.,new_var) %>% 
  mutate_at(vars(2:9), round, 2)
}
```

## Mothers & Newborns

* 5 phenols  
* 3 parabens  
* 9 phthalates  

```{r, read,}
ewa <- readMat(here::here("./Data/mn2_EWA_sd1.mat"))[[1]] %>% as_tibble() %>% rename(P1 = V1, P2 = V2)
whole = bind_cols(ppp_cov, ewa) %>% left_join(., mn_outcome) %>% rename(HOME_SCORE = HOMETOT)

mn = whole %>% filter(P1 < mean(whole$P1) + 5*sd(whole$P1)) %>% 
  mutate_at(vars(c(HOME_SCORE, M_AGE, M_IQ)), scale)
```

```{r}
summary(ewa)
```

## Demographics

```{r, demo}
ppp_343 = ppp_cov %>% mutate(Subsample = "Study Population") %>% rename(HOME_SCORE = HOMETOT)
# 343 with pht/phenol exposure
ppp_current = ppp_343 %>% filter(!is.na(WISC))
# 311 with WISC

cohort = mn_demo %>% 
        left_join(., mn_outcome, by = "SID") %>% 
        dplyr::select(-c(WISC_VC, WISC_PR, WISC_PS, WISC_WM)) %>% 
        mutate(Subsample = "Entire Cohort") %>% 
        rename(HOME_SCORE = HOMETOT)

demo =  bind_rows(ppp_current, cohort) %>% 
        mutate_at(vars(SMOKER_IN_HOME, SEX, ALCOHOL), as_factor) %>% 
        dplyr::select(ETH, M_AGE, M_EDU, M_IQ, HOME_SCORE, mat_hard, MARITAL_STATUS, ALCOHOL, SMOKER_IN_HOME, 
                      SEX, WISC, Subsample) %>% 
        rename(Ethnicity = ETH,
               `Maternal education` = M_EDU,
               `Marital status` = MARITAL_STATUS,
               `Child sex` = SEX,
               `HOME scale` = HOME_SCORE,
               `Maternal IQ` = M_IQ,
               `Maternal age at delivery` = M_AGE,
               `Prenatal alcohol consumption` = ALCOHOL,
               `Smoker in home` = SMOKER_IN_HOME,
               `Material hardship` = mat_hard,
               `Child Full Scale IQ` = WISC) %>% 
        mutate(Subsample = fct_inorder(Subsample))

demo %>% tbl_summary(by = Subsample, missing = "no",
                     statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
                     add_p() %>% as_gt() %>% 
        tab_header(title = "Subject demographics and distribution of potential confounders, model covariates, and outcome variable")

# demo %>% filter(Subsample == "Study Population") %>% 
#          tbl_summary(missing = "no",
#          statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
#         as_kable_extra(., format = "latex")
```

## Distributions \& dectection

```{r, lod}
lod <- mn_phenol %>% drop_na(BP_3:BPA) %>% 
          rename(B_PB_detect = B_PB_LOD_0_2, TCS_detect = TCS_LOD_2_3, 
                DCP_24_detect = X24_DCP_LOD_0_2, BP_3_detect = BP_3_LOD_0_4) %>%   
          mutate_at(vars(10:13), ~ifelse(is.na(.), 0, 1)) %>% 
          inner_join(., mn_pht, by = "SID") %>% 
  dplyr::select(grep("detect", colnames(.))) %>%
  gather(chem, level) %>% 
  mutate(level = ifelse(level > 1, 0, level)) %>% 
  group_by(chem, level) %>% 
  summarize(n = n()) %>% 
  spread(level, n) %>% 
  mutate_all(~replace_na(., 0))
# Number of obs with each flag for each pht
# 14 bc 3 detected 100%

detected <- lod %>% 
  mutate(Prop_Detected = `0`/(`1` + `0`),
         `% <LOD` = 1 - Prop_Detected) %>%
  ungroup() %>% 
  dplyr::select(Chemical = chem, `% <LOD`) %>% 
  mutate(Chemical = str_remove(Chemical, "_detect")) %>% 
  rbind(., tibble(Chemical = "M_PB",   `% <LOD` = 0)) %>% 
  rbind(., tibble(Chemical = "P_PB",   `% <LOD` = 0)) %>% 
  rbind(., tibble(Chemical = "DCP_25", `% <LOD` = 0))

conc = mn_ppp %>% 
  pivot_longer(MEHHP:BPA,
               names_to = "Chemical") %>% 
  group_by(Chemical) %>% 
  summarise(Mean = mean(value, na.rm = TRUE),
            Stdev = sd(value, na.rm = TRUE),
            Min = min(value, na.rm = TRUE),
            qs = quantile(value, c(0.25, 0.5, 0.75), na.rm = TRUE), prob = c("Q25", "Median", "Q75"),
            Max = max(value, na.rm = TRUE)) %>% 
  pivot_wider(names_from = "prob",
              values_from = "qs") %>% 
  dplyr::select(Chemical:Min, Q25:Q75, Max)

ppp_table <- left_join(detected, conc, by = c("Chemical")) %>%
  mutate_if(is.numeric, round, digits = 2) %>% 
  mutate(group = case_when(Chemical == "M_PB" ~ "phenols",
                           grepl("^M", Chemical) ~ "phthalates",
                           TRUE ~ "phenols")) %>% 
  arrange(group, Chemical) %>% 
  dplyr::select(-group)

ppp_table  

# %>% knitr::kable(caption = "Distribution of phathlate metabolites & phenols (ng/ml) in maternal spot urine during # the third trimester of pregnancy (n = 343)")

# ppp_table %>% 
#   dplyr::select(1:2, 6:8) %>% 
#   stargazer::stargazer(summary = F)
```

### Chemicals

```{r, fig1, fig.height=10, fig.width=12}
mn_ppp %>% 
  pivot_longer(MEHHP:BPA) %>% 
  mutate(name = str_replace(name, "_", "-")) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(aes(y = ..density..), alpha=0.65, fill = "#0072B5") +
  facet_wrap(name~., scales = "free") + 
  labs(y = "Density", x="") +
  theme(axis.text.y = element_blank(),
         axis.text.x = element_text(size = 10))
```

### Correlation

```{r, fig.height=7, fig.width=7}
cormat <- get_lower_tri(round(cor(mn_ppp[,-1], use = "complete.obs", 
                                  method = c("spearman")),2))[2:17, 1:16]

melted_cormat <- melt(cormat) %>% 
  rename(Correlation = value) %>% 
  mutate(Var1 = str_replace(Var1, "_", "-"),
    Var1 = fct_inorder(Var1),
    Var2 = str_replace(Var2, "_", "-"),
    Var2 = fct_inorder(Var2))

ggplot(data = melted_cormat, aes(x = Var1, y = Var2)) + 
  geom_tile(aes(fill = Correlation), color = "white") + 
  scale_fill_gradient2(low = "#046C9A", mid = "beige", high = "#F21A00",
                       na.value = "grey80") +
  labs(x = "", y = "", title = "") +
  theme_test(base_size = 20) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(size = 8),
        legend.position = "bottom")
```

## Exposure patterns

### Loadings
```{r, load-load}
eh <- readMat(here::here("./Data/mn2_EH.mat"))[[1]]
# ["MEHHP", "MECPP", "MEOHP", "MEHP", "MCPP", "MIBP", "MBP", "MBZP", "MEP", "BP_3", "B_PB", "M_PB", "P_PB", "TCS", "DCP_24", "DCP_25", "BPA"];

colnames(eh) <- c("MEHHP", "MECPP", "MEOHP", "MEHP", "MCPP", "MIBP", "MBP", "MBZP", "MEP", "BP_3", "B_PB", "M_PB", "P_PB", "TCS", "DCP_24", "DCP_25", "BPA")

applied <- eh %>% 
  as_tibble() %>% 
  mutate(Pattern = 1:2) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>%
  mutate(Class = as_factor(case_when(grepl("PB", Chemicals) ~ "Parabens",
                           grepl("^M[A-Z]", Chemicals) ~ "Phthalates",
                           TRUE ~ "Phenols")),
         Chemicals = str_replace(Chemicals, "_", "-")) %>% 
  mutate(Pattern = paste0("Pattern ", Pattern),
         Chemicals = fct_inorder(Chemicals))

eh_plot = 
  ggplot(data = applied, aes(x = Pattern, y = Chemicals)) + 
  geom_tile(aes(fill = Loadings), color = "white") + 
  scale_fill_gradient2(low = "#046C9A", mid = "beige", high = "#F21A00") +
  labs(x = "", y = "", title = "") + 
  theme_minimal(base_size = 20) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        legend.position = "bottom",
        panel.grid.major = element_blank())
```

```{r, load-cor, cache=TRUE}
chem_pat = bind_cols(mn_ppp, ewa) %>% dplyr::select(-SID) %>% as.matrix()

cormat_p <- get_lower_tri(round(cor(chem_pat, use = "complete.obs", 
                                  method = c("spearman")),2))[18:19,]

melted_cormat_p <- melt(cormat_p) %>% 
  rename(Correlation = value) %>% 
  mutate(Var1 = str_replace(Var1, "_", "-"),
    Var1 = fct_inorder(Var1),
    Var2 = str_replace(Var2, "_", "-"),
    Var2 = fct_inorder(Var2)) %>% 
  filter(!(Var2 %in% c("P2","P1"))) %>% 
  mutate(Var1 = case_when(Var1 == "P1" ~ "Pattern 1",
                          Var1 == "P2" ~ "Pattern 2"))

corr_plot = 
  ggplot(data = melted_cormat_p, aes(x = Var1, y = Var2)) + 
  geom_tile(aes(fill = Correlation), color = "white") + 
  scale_fill_gradient2(low = "#046C9A", mid = "beige", high = "#F21A00", limits = c(-1,1)) +
  labs(x = "", y = "", title = "") +
  theme_minimal(base_size = 20) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        legend.position = "bottom",
        panel.grid.major = element_blank())
```

```{r, fig.height=8}
eh_plot + corr_plot
```

### Distributions

```{r, figpc, fig.height=7}
ewa %>% 
  pivot_longer(P1:P2) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(aes(y = ..density..), alpha=0.65, fill = "#0072B5") +
  facet_wrap(name~., scales = "free") + 
  labs(y = "Density", x = "")

bind_cols(ppp_343, ewa) %>% 
  mutate(SEX = fct_relevel(SEX, "Male", after = 1)) %>% 
  pivot_longer(P1:P2) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(aes(y = ..density.., fill = SEX), alpha = 0.65, position = "identity") +
  facet_wrap(name~., scales = "free") + 
  labs(y = "Density", x="")
```

### Sources

```{r, sources, cache=TRUE, fig.width = 4, fig.height=8}
load("./pattern_source_heat_data.rda")

ggplot(data = heat_gg, aes(x = pattern, y = product)) + 
  geom_tile(aes(fill = beta)) + 
  #scale_fill_distiller(palette = "RdBu")
  scale_fill_gradient2(low = "#046C9A", mid = "beige", high = "#F21A00") +
  geom_text(aes(label = sig), size = 10, color = "white", vjust = .8) +
  labs(x = "", y = "", fill = "Coefficient") + 
  theme_minimal(base_size = 20) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 12),
        legend.position = "bottom",
        panel.grid.major = element_blank())
```

## Health models

```{r}
par(mfrow=c(1,2))
summary(gam(WISC ~ s(P2, by = SEX) + SEX, data = mn))
plot(gam(WISC ~ s(P2, by = SEX) + SEX, data = mn)) 
```

### Unadjusted

```{r}
fit_p1 <- lm(WISC ~ P1 + SEX + SEX*P1, data = mn)
add_ci4interaction(fit_p1, "P1", "P1:SEXFemale")

fit_p2 <- lm(WISC ~ P2 + SEX + SEX*P2, data = mn)
add_ci4interaction(fit_p2, "P2", "P2:SEXFemale")
```

### Adjusted

#### Pattern 1

```{r}
fit_p1a <- lm(WISC ~ P1 + SEX*P1 + SEX + M_IQ + ALCOHOL + M_EDU  + M_AGE +
              MARITAL_STATUS + HOME_SCORE + mat_hard
             , data = mn)
summary(fit_p1a)
add_ci4interaction(fit_p1a, "P1", "P1:SEXFemale")
glance(fit_p1a)[,-c(11:12)]
```

#### Pattern 2

```{r}
fit_p2a <- lm(WISC ~ P2 + SEX*P2 + SEX + M_IQ + ALCOHOL + M_EDU + M_AGE +
              MARITAL_STATUS + HOME_SCORE + mat_hard
             , data = mn)
add_ci4interaction(fit_p2a, "P2", "P2:SEXFemale")
glance(fit_p2a)[,-c(11:12)]

summary(fit_p2a)
```

#### Table

```{r}
tabp1 = add_ci4interaction(fit_p1a, "P1", "P1:SEXFemale")[c(2,11:12),] %>% mutate(pattern = "Pattern 1")
tabp2 = add_ci4interaction(fit_p2a, "P2", "P2:SEXFemale")[c(2,11:12),] %>% mutate(pattern = "Pattern 2")

load("./Stan/fits/pattern1_noninf_fit.rda")
bayesp1 = add_ci4int_bayes(p1_non)[c(9,11,12),]%>% mutate(pattern = "Pattern 1")

load("./Stan/fits/pattern2_noninf_fit.rda")
bayesp2 = add_ci4int_bayes(p2_non)[c(9,11:12),]%>% mutate(pattern = "Pattern 2")

tabfreq = bind_rows(tabp1, tabp2)[,c(1:2, 6:8)] %>% mutate(model = "Traditional")

tabbayes = bind_rows(bayesp1, bayesp2)[,c(1,7, 5, 9:10)] %>% as_tibble() %>% 
            rename(term = beta, estimate = `50%`) %>% 
            rename_all(~str_replace(., "%", " %")) %>% 
            mutate(model = "Bayesian")

model_table = bind_rows(tabfreq, tabbayes) %>% dplyr::select(model, pattern, everything()) %>% 
  arrange(model, pattern, term) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  mutate(`95% Confidence Interval` = str_c("(", `2.5 %`, ", ", `97.5 %`, ")")) %>% 
  mutate(term = case_when(term == "sex*p" | grepl("SEX", term) ~ " interaction term",
                          TRUE ~ term),
         term = str_remove(term, "(P1|P2|p)"),
         term = str_c(pattern, term)) %>% 
    dplyr::select(-`2.5 %`, -`97.5 %`, -pattern)

stargazer::stargazer(model_table, summary = F)
```


### Viz

```{r, fig.height=7}
pred_1 = predict(fit_p1a, se.fit = TRUE)
pred_2 = predict(fit_p2a, se.fit = TRUE)

# Subset so that n matches regression results
mn_subset = mn %>% dplyr::select(SID, WISC, P_1 = P1, P_2 = P2, SEX, M_IQ, ALCOHOL, M_EDU, M_AGE,
                                 MARITAL_STATUS, HOME_SCORE) %>% drop_na() %>% 
              mutate(model = "Main Model")

pred = bind_cols(mn_subset, pred_1 = pred_1$fit, se_1 = pred_1$se.fit,
                            pred_2 = pred_2$fit, se_2 = pred_2$se.fit)

# Combine predicted outcomes with data
main = 
  pred %>% 
  dplyr::select(-c(M_IQ, ALCOHOL, M_EDU, MARITAL_STATUS, HOME_SCORE, M_AGE)) %>% 
  mutate(SEX = fct_relevel(SEX, "Male", after = 1)) %>%
  pivot_longer(c(P_1:P_2, pred_1:se_2),
               names_to = c("term", "pattern"),
               names_sep = "_") %>% 
  pivot_wider(names_from = term,
              values_from = value)

main %>% 
  mutate(pattern = ifelse(pattern == "2", "Pattern 2", "Pattern 1")) %>% 
  ggplot(aes(x = P, fill = SEX, color = SEX)) +
  geom_point(aes(y = WISC), alpha=0.25, size = 0.5) +
  geom_smooth(aes(y = pred),
              method = "lm", fullrange = TRUE, se=F) +
  geom_smooth(aes(y = pred + 1.96*se), 
              se=F, linetype = "dotted", size = 0.5,
              method = "lm", fullrange = TRUE) +
  geom_smooth(aes(y = pred - 1.96*se), 
              se=F, linetype = "dotted", size = 0.5, method = "lm", fullrange = TRUE) +
  facet_wrap(.~pattern) + 
  labs(y = "WISC Full Scale IQ", x = "Pattern concentration")
```

### Viz Pattern 1

```{r}
pred_one = main %>% filter(pattern == "1")

sum_one = add_ci4interaction(fit_p1a, "P1", "P1:SEXFemale")

female_se = sum_one[12, 3][[1]]
male_se = sum_one[2, 3][[1]]

# CI = beta confidence interval
# slope +/- 2*standard error of slope
pred_one %>% 
  mutate(pattern = ifelse(pattern == "2", "Pattern 2", "Pattern 1")) %>% 
  ggplot(aes(x = P, fill = SEX, color = SEX)) +
  geom_point(aes(y = WISC), alpha=0.25, size = 0.5) +
  geom_smooth(aes(y = pred,
              ymin = after_stat(y) - male_se*1.96,
              ymax = after_stat(y) + male_se*1.96),
              method = "lm", fullrange = TRUE, alpha = 0.3,
              data = subset(pred_one, SEX == "Male")) +
  # geom_abline(slope = -3.45, intercept = 100) +
  geom_smooth(aes(y = pred,
              ymin = after_stat(y) - female_se*1.96,
              ymax = after_stat(y) + female_se*1.96),
              method = "lm", fullrange = TRUE, alpha = 0.3,
              data = subset(pred_one, SEX == "Female")) +
  # geom_abline(slope = bayes_f_slope, intercept = 100) +
  # geom_abline(slope = bayes_f_slope, intercept = 100+bayes_female_up) +
  # geom_abline(slope = bayes_f_slope, intercept = 100-bayes_female_low) +
  labs(y = "WISC Full Scale IQ", x = "Pattern concentration") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 15),
        legend.position = c(0.2, 0.125), # c(1,0) right bottom, c(1,1) right top.
        legend.background = element_rect(fill = "#ffffffaa", colour = NA))

# CI = prediction confidence interval
# pred value +/- 2*se of prediction
pred_one %>% 
  ggplot(aes(x = P, fill = SEX, color = SEX)) +
  geom_point(aes(y = WISC), alpha=0.25, size = 0.5) +
  geom_smooth(aes(y = pred),
              method = "lm", fullrange = TRUE, se=F) +
  geom_smooth(aes(y = pred + 1.96*se), 
              se=F, linetype = "dotted", size = 0.5,
              method = "lm", fullrange = TRUE) +
  geom_smooth(aes(y = pred - 1.96*se), 
              se=F, linetype = "dotted", size = 0.5, method = "lm", fullrange = TRUE) +
  labs(y = "WISC Full Scale IQ", x = "Pattern concentration") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 15),
        legend.position = c(0.2, 0.125), # c(1,0) right bottom, c(1,1) right top.
        legend.background = element_rect(fill = "#ffffffaa", colour = NA))
```

```{r}
load("./Stan/fits/pattern1_noninf_fit.rda")
bayes_sum = add_ci4int_bayes(p1_non)

bayes_f_slope = bayes_sum[12,7]
bayes_m_slope = bayes_sum[11,7]

bayes_female_up = bayes_sum[12,9] - bayes_sum[12,7]
bayes_female_low = -(bayes_sum[12,5] - bayes_sum[12,7])

bayes_male_up = bayes_sum[11,9] - bayes_sum[11,7]
bayes_male_low = -(bayes_sum[11,5] -bayes_sum[11,7])
  
# Extract fit
ext_p1 <- extract(p1_non)
str(ext_p1)

y_pred_p1 = ext_p1$y_tilde

y_median = apply(y_pred_p1, 2, median)
y_upper = apply(y_pred_p1, 2, quantile, .975)
y_lower = apply(y_pred_p1, 2, quantile, .025)

y_all = tibble(y_median, y_lower, y_upper)

pred_bayes = bind_cols(pred_one, y_all)

pred_bayes %>% 
  ggplot(aes(x = P, fill = SEX, color = SEX)) +
  geom_point(aes(y = WISC), alpha=0.25, size = 0.5) +
  geom_smooth(aes(y = y_median),
              method = "lm", fullrange = TRUE, se=F) +
  geom_smooth(aes(y = y_lower), 
              se=F, linetype = "dotted", size = 0.5,
              method = "lm", fullrange = TRUE) +
  geom_smooth(aes(y = y_upper), 
              se=F, linetype = "dotted", size = 0.5, method = "lm", fullrange = TRUE) +
  labs(y = "WISC Full Scale IQ", x = "Pattern concentration") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 15),
        legend.position = c(0.2, 0.125), # c(1,0) right bottom, c(1,1) right top.
        legend.background = element_rect(fill = "#ffffffaa", colour = NA))

pred_bayes %>% 
  mutate(pattern = ifelse(pattern == "2", "Pattern 2", "Pattern 1")) %>% 
  ggplot(aes(x = P, fill = SEX, color = SEX)) +
  geom_point(aes(y = WISC), alpha=0.25, size = 0.5) +
  geom_smooth(aes(y = y_median,
              ymin = after_stat(y) - bayes_male_low,
              ymax = after_stat(y) + bayes_male_up),
              method = "lm", fullrange = TRUE, alpha = 0.3,
              data = subset(pred_bayes, SEX == "Male")) +
  geom_abline(slope = bayes_f_slope, intercept = 100) +
  geom_abline(slope = bayes_f_slope, intercept = 100+bayes_female_up) +
  geom_abline(slope = bayes_f_slope, intercept = 100-bayes_female_low) +
  geom_smooth(aes(y = pred,
              ymin = after_stat(y) - bayes_female_low,
              ymax = after_stat(y) + bayes_female_up),
              method = "lm", fullrange = TRUE, alpha = 0.3,
              data = subset(pred_bayes, SEX == "Female")) +
  labs(y = "WISC Full Scale IQ", x = "Pattern concentration") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 15),
        legend.position = c(0.2, 0.125), # c(1,0) right bottom, c(1,1) right top.
        legend.background = element_rect(fill = "#ffffffaa", colour = NA))
```

  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  
  <br>  

## Extra

### Some missingness
  
**Are the people missing WISC the same as the people missing HOME?**  
  
There are `r ppp_343 %>% filter(is.na(HOME_SCORE)) %>% nrow()` people missing `HOME` and `r ppp_343 %>% filter(!is.na(WISC) & is.na(HOME_SCORE)) %>% nrow()` people missing `HOME` but not `WISC`. This is `r round((16/(343-32))*100, 2)`% of 311 (total with WISC).  
  
**Are the people missing WISC the same as the people missing maternal IQ?**  
  
There are `r ppp_343 %>% filter(is.na(M_IQ)) %>% nrow()` people missing `maternal IQ` and `r ppp_343 %>% filter(!is.na(WISC) & is.na(M_IQ)) %>% nrow()` people missing `maternal IQ` but not `WISC`. This is `r round((8/(343-32))*100,2)`% of 311. Two people are missing both `HOME` and `maternal IQ`.
  
**Can age 9 HOME predict age 7?**  
  
`all:`  
`lm(formula = HOMETOT ~ HOME_TOT9, data = combo)`  
`---`  
`Residuals:`  
`    Min      1Q  Median      3Q     Max `  
`-17.716  -2.943   1.099   3.830  10.645 `  
`---`  
`Coefficients:`  
`            Estimate Std. Error t value Pr(>|t|)     `  
`(Intercept) 30.41181    2.95846  10.280  < 2e-16 *** `  
`HOME_TOT9    0.22694    0.07178   3.161  0.00201 **  `  
`---`  
`Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1`  
`---`  
`Residual standard error: 5.696 on 115 degrees of freedom`   
`  (610 observations deleted due to missingness)`  
`Multiple R-squared:  0.07996,	Adjusted R-squared:  0.07196 `  
`F-statistic: 9.995 on 1 and 115 DF,  p-value: 0.002008`   
  

**Can age 9 WISC predict age 7?**  
  
`Call:` 
`lm(formula = WISC ~ WSC_CSFS_108, data = combo)`  
`---`  
`Residuals:`  
`    Min      1Q  Median      3Q     Max `  
`-23.622  -5.513  -0.530   5.378  23.562 `  
`---`  
`Coefficients:`  
`             Estimate Std. Error t value Pr(>|t|)    `  
`(Intercept)  23.46166    2.73993   8.563   <2e-16 ***`  
`WSC_CSFS_108  0.78160    0.02839  27.530   <2e-16 ***`  
`---`  
`Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1`  
`---`  
`Residual standard error: 7.938 on 461 degrees of freedom`  
`  (264 observations deleted due to missingness)`  
`Multiple R-squared:  0.6218,	Adjusted R-squared:  0.621 `  
`F-statistic: 757.9 on 1 and 461 DF,  p-value: < 2.2e-16`  
  
  
### Sensitivity

```{r, fig.height=7}
fit_sense_1 <- gam(WISC ~ s(P1, by = SEX) + SEX + M_IQ + ALCOHOL + M_EDU + 
                     MARITAL_STATUS + HOME_SCORE + M_AGE + SMOKER_IN_HOME, 
                 data = whole)
fit_sense_2 <- gam(WISC ~ s(P2, by = SEX) + SEX + M_IQ + ALCOHOL + M_EDU + MARITAL_STATUS + 
                     HOME_SCORE + M_AGE + SMOKER_IN_HOME,
                    data = whole)

ps_predict_1 = as_tibble(predict(fit_sense_1, se.fit = T))
ps_predict_2 = as_tibble(predict(fit_sense_2, se.fit = T))

mn_subset = whole %>% dplyr::select(SID, WISC, P_1 = P1, P_2 = P2, SEX, M_IQ, ALCOHOL, M_EDU, M_AGE, SMOKER_IN_HOME,
                                 MARITAL_STATUS, HOME_SCORE) %>% drop_na()

spline_pred = bind_cols(mn_subset, pred_1 = ps_predict_1$fit, se_1 = ps_predict_1$se.fit,
                                   pred_2 = ps_predict_2$fit, se_2 = ps_predict_2$se.fit) %>% 
              mutate(model = "Penalized Spline")

sense_all = bind_rows(spline_pred, pred) %>% 
  dplyr::select(-c(M_IQ, ALCOHOL, M_EDU, MARITAL_STATUS, HOME_SCORE, M_AGE, SMOKER_IN_HOME)) %>% 
  pivot_longer(c(P_1:P_2, pred_1:se_2),
               names_to = c("term", "pattern"),
               names_sep = "_") %>% 
  pivot_wider(names_from = term,
              values_from = value) %>% 
  mutate(extreme = ifelse(SID %in% c(453, 1209, 1229), "Yes", "No"),
         pattern = ifelse(pattern == "2", "Pattern 2", "Pattern 1"))

pal = brewer.pal(11, "RdBu")[c(2,4,11,10)]

sense_all %>% 
  ggplot(aes(x = P, fill = interaction(SEX, model))) +
  geom_point(aes(y = WISC), alpha=0.25, color="grey") +
  geom_point(aes(y = WISC), color="black",
             data = subset(sense_all, extreme =="Yes")) +
  geom_smooth(aes(y = pred, color = interaction(SEX, model)), 
              method = "gam", formula = y ~ s(x), se=F,
              data = subset(sense_all, model =="Penalized Spline"),
              linetype = 'dashed', fullrange = TRUE) +
    geom_smooth(aes(y = pred - 1.96*se, color = interaction(SEX, model)), 
              method = "gam", formula = y ~ s(x), se=F,
              data = subset(sense_all, model =="Penalized Spline"),
              linetype = 'dotted', size = 0.5, fullrange = TRUE) +
    geom_smooth(aes(y = pred + 1.96*se, color = interaction(SEX, model)), 
              method = "gam", formula = y ~ s(x), se=F,
              data = subset(sense_all, model =="Penalized Spline"),
              linetype = 'dotted', size = 0.5, fullrange = TRUE) +
  geom_smooth(aes(y = pred, color = interaction(SEX, model)),
              method = "lm", se=F,
              data = subset(sense_all, model =="Main Model"),
              fullrange = TRUE) +
    geom_smooth(aes(y = pred - 1.96*se, color = interaction(SEX, model)),
              method = "lm", se=F,
              data = subset(sense_all, model =="Main Model"),
              linetype = 'dotted', size = 0.5, fullrange = TRUE) +
    geom_smooth(aes(y = pred + 1.96*se, color = interaction(SEX, model)),
              method = "lm", se=F,
              data = subset(sense_all, model =="Main Model"),
              linetype = 'dotted', size = 0.5, fullrange = TRUE) +
  scale_fill_manual(values = pal, labels = c("", "Female", "", "Male")) +
  scale_color_manual(values = pal, labels = c("", "Female", "", "Male")) +
  facet_wrap(.~pattern, scales = "free_x") + 
  labs(y = "WISC Full Scale IQ", x = "Pattern concentration") +
  theme(legend.title = element_blank())
```

#### Extreme values

```{r}
#bind_cols(mn_ppp, ewa) %>% filter(P2 > 30) %>% select(SID, P1, P2, everything())
  
extreme = bind_cols(mn_ppp, ewa) %>% filter(P2 > mean(P2) + 5*sd(P2)) %>%
  t() %>% as.data.frame() %>% rownames_to_column(var = "Chemical") %>% 
  mutate_at(vars(2:4), as.numeric) %>% 
  filter(Chemical != "SID")
```

```{r, figend, fig.height=10, fig.width=12}
mn_ppp %>%
  pivot_longer(MEHHP:BPA,
               names_to = "Chemical") %>% 
  left_join(., extreme) %>% 
  filter(grepl("^M", Chemical) | Chemical == "BPA") %>%
  filter(!(Chemical %in% c("MEP", "M_PB"))) %>% 
  mutate(Chemical = str_replace(Chemical, "_", "-")) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(aes(y = ..density..), fill = "#0072B5", alpha=0.75) +
  geom_vline(aes(xintercept = V1), linetype = "dashed", color = "#E18727") + 
  geom_vline(aes(xintercept = V2), linetype = "dashed", color = "#20854E") + 
  geom_vline(aes(xintercept = V3), linetype = "dashed", color = "#F21A00") + 
  facet_wrap(Chemical~., scales = "free") + 
  labs(y = "Density", x="") +
  theme(axis.text.y = element_blank(),
        text = element_text(size = 30),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 35))
```

Highest female = Red  
2nd highest female = Green  
Highest male = Yellow  
  

